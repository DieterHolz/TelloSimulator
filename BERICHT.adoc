:imagesdir: assets
:toc: macro

= 20FS_IMVS08: Tello Simulator

[.text-center]
*Implementierung eines Simulators für die Tello Drohne*
[.text-center]
image::fhnw_ht_10mm.jpg[width=400]
[.text-center]
IP5 im Studiengang Informatik mit Vertiefung in Design und Management an der Fachhochschule Nordwestschweiz +
v0.1 +
Brugg, 6. Oktober 2020

[.text-center]
*Autoren* +
Daniel Obrist +
Severin Peyer +


[.text-center]
*Auftraggeber* +
Fachhochschule Nordwestschweiz FHNW +
vertreten durch Dieter Holz und Barbara Scheuner +
Bahnhofstrasse 6 +
5210 Windisch

[.text-center]
*Betreuer* +
Dr. Dieter Holz +
Dr. Barbara Scheuner

'''
[discrete]
== Impressum

:toc-title: Inhaltsverzeichnis
toc::[]

== Management Summary
== Einleitung
=== Ausgangslage
Im Workshop-Modul 2 (Programmieren von Minidrohnen und "intelligente Kleidung") der Fachhochschule Nordwestschweiz (FHNW) wird die Tello EDU von Ryze Robotics <<telloedu>> (nachfolgend: Tello-Drohne) eingesetzt. Dabei werden in Teams von durchschnittlich 4 Mitgliedern Applikationen zur Steuerung der Drohne entwickelt. Jedem Team steht dabei eine Tello-Drohne zur Verfügung.

=== Problem
Es hat sich gezeigt, dass die Drohne sehr schnell zu einem Engpass führt, da insbesondere im frühen Entwicklungsstadium viel mit der Drohne experimentiert werden muss. Dadurch verzögert sich der Projektfortschritt. Des Weiteren ist es auch bereits zu mehreren Missgeschicken mit der Drohne gekommen. Beispielsweise wurde vergessen ein Stopp-Signal einzubauen, weswegen die Drohne in eine Wand geflogen und kaputt gegangen ist.

=== Anforderungen
Um die beiden Probleme zu minimieren, repsektive eleminieren, soll ein Simulator entwickelt werden, welcher sich möglichst gleich verhält wie die echte Tello-Drohne. Dieser soll rein software-technisch umgesetzt werden, damit nicht wieder die Abhängigkeit von einem technischen Gerät entsteht. Der Simulator muss die Programmierschnittstelle des Tello SDK 2.0 anbieten. Folgende Anforderungen wurden definiert:

* Der Simulator kann Kommandos des Operators entgegennehmen und eine Response senden
* Die virtuelle Drohne setzt alle Control-, Read- und Set-Commands visuell realitätsgetrau um
* Der Simulator kann einen Status auf einem separaten Port an den Operator senden
* Der Simulator kann einen Videostream aus der Sicht der Drohne an den Operator senden
* Error-Handling (ungültige Befehle, ungültige Parameter)

Für das Extended Product, haben wir folgende Kann-Ziele definiert:

* Per UI kann eine Raumgrösse eingegeben werden (LxBxH) und eine Startposition der Drohne (x, y und Start am Boden)
* Der Simulator kann mit mehreren Drohnen (Drohnenschwärme) umgehen


=== Lösung
=== Zielpublikum

== Theoretischer Teil

=== Beschreibung der Anwendungsdomäne
Der Simulator wird im Workshop-Modul als Ersatz für die echte Tello-Drohne eingesetzt.


=== Beschreibung der verwendeten Methoden
Da der Einsatzbereich sich auf das Workshop-Modul beschränkt, reicht es, wenn die Applikation mit Gradle gebuildet
werden kann.

== Praktischer Teil

=== Usability Testing
Dieses Kapitel beschreibt im Speziellen die Erkenntnisse, welche aus einem Usability Testing gewonnen werden konnten. Des Weiteren wird die Vorgehensweise des Testings kurz erläutert. Das Testkonzept, das Tesatskript, die Testprotokolle sowie die Auswertung sind im Anhang unter «Usability Testing» zu finden.
Das Testing wurde auf dem Commit e63f7657acbb2ce787390f7302206a44baecf067 durchgeführt, die Ansicht des GUIs wird in Abbildung 1 gezeigt.

.GUI zum Stand des Usability Testings
[#gui-usability-testing]
[caption="Abbildung 1: "]
image::tello-simulator-gui-stand-usability-testing.png[width=498]

==== Vorgehensweise
Um eine unkomplizierte Inbetriebnahme sowie eine einfache Handhabung des Simulators zu gewährleisten, wurde ein Usability Testing durchgeführt.

Das Testing wurde in die folgenden drei Abschnitte unterteilt: «Installation», «Konfiguration des Operators» und «Anwendung TelloSimulator», diese werden im Kapitel «Aufgabenstellung» etwas genauer beschrieben. Per Videotelefonie wurde das Testing mit vier iCompetence-Studierenden der FHNW (2./3. Semester) durchgeführt. Dabei wurde eine Aufgabenstellung per Chat abgegeben und der Proband versuchte die Aufgabe ohne Hilfe des Moderierenden zu lösen. Der Moderierende konnte bei Problemen eingreifen, der Beobachtende notierte die wichtigsten Verhaltensweisen und Aussagen des Probanden. Zusätzlich wurde das Meeting aufgezeichnet, um wichtige Abschnitte nachgehend noch detaillierter zu dokumentieren.

Anschliessend wurden die wichtigsten Erkenntnisse in die folgenden Kategorien unterteilt: «negative Aussagen / beobachtete Probleme», «positive Aussagen» und «Tipps». Diese wurden nach Thema gruppiert. Pro Thema wurde ein Verbesserungsvorschlag definiert und ins Backlog aufgenommen.

==== Erkenntnisse
Durch das Usability Testing konnten die folgenden Erkenntnisse gewonnen werden. Dies ist nur ein Auszug der Wichtigsten, genauere Details sind im Anhang zu finden.

*Installationsanleitung*

** weniger Beschreibungen, warum etwas gemacht wird, dafür genauere Anweisungen
** Probleme, welche auftreten können, in einen Troubleshooting-Abschnitt extrahieren

*Simulator*

** visuelle Orientierung im Raum ist sehr wichtig, um zu sehen, ob die Drohne sich wie gewünscht verhält
*** Schatten einbauen
*** Kameraposition überdenken
*** Drohne als 3D-Model implementieren oder mindestens ein Pfeil auf dem Quader einblenden, damit die Blickrichtung der Drohne klar ist
** Drohne/Simulator muss auch wieder ausgeschaltet werden können
** GUI ist noch nicht sehr strukturiert (schwierig, wichtige Infos zu finden)

=== Use-Cases
=== Architektur

Hier wird die Software-Architektur des Simulators beschrieben. Die nachfolgende Grafik bietet einen Überblick der
wichtigsten Klassen. Anschliessend werden diese Klassen und deren Funktionen genauer beschrieben.

<Diagramm mit den wichtigsten Klassen>

==== Frontend
Das User-Interface des Simulators ist mit den typischen JavaFX-Bausteinen aufgebaut. Die Benutzerfreundlichkeit wurde
bei der Gestaltung nicht speziell beachtet und hat bestimmt noch ein gewisses Verbesserungspotenzial. Als zukünftige
Weiterentwicklung könnte man bestimmt noch einen Sprint in das User-Experience stecken. Da sich unser Projekt jedoch auf
die Grundfunktionalität fokussierte, haben wir nicht viele Ressourcen in die Usabilty investiert.

===== SimulatorPane
Die SimulatorPane ist die übergeordnete BorderPane, welche alle anderen JavaFX-Nodes enthält. Links befinden sich die
SimulatorControls zum Setzen und Beobachten von Simulator- und Drohnen-Parametern. Auf der rechten Seite sind die
NetworkControls, wo alle nötigen Informationen zum Verbindungsaufbau mit dem Simulator angezeigt werden. Unten findet
der User eine interaktive LogBox, welche dem Debugging dient. Und in der Mitte befindet sich die Simulator3DScene, in
welcher die 3D-Welt und die virtuelle Drohne gerendert werden.

<Screenshot des gesamten GUI>

====== SimulatorControls
Diese Komponente zeigt die wichtigsten Parameter der Drohne an. Dazu gehören die X-, Y- und Z-Position sowie die Yaw-, Pitch- und Roll-Werte.
Zusätzlich steht ein Reset-Button zur Verfügung, wodurch alle Werte der virtuellen Drohne zurückgesetzt werden. Mit dem Button darunter kann 
der User ausserdem zwischen Simulator- und Drohnenkamera wechseln. Zusätzlich befinden sich hier vier Slider zur Konfiguration der Grösse des
virtuellen Raums. Ist ein Slider angewählt können die Werte auch mit den Pfeiltasteneingestellt werden.

====== NetworkControls
Die NetworkControls auf der rechten Seite bieten als Erstes den *Start Drone*-Button, mit welchem die virtuelle Drohne ein- und ausgeschaltet
werden kann. Dieser Button repräsentiert in der Funktionsweise den On-Off-Schalter der echten Tello-Drohne. Denn erst nachdem die Tello-Drohne eingeschaltet wurde kann man sich mit ihr verbinden. Analog müss auch die virtuelle Drohne zuerst gestartet werden. Nach einem
Betätigen des "Start Drone"-Buttons baut der Simulator die CommandConnection auf und beginnt auf dem entsprechenden Port commands zu empfangen. 
Eine ensprechende Nachricht wird ebenfalls in den Log geschrieben, um dem User zu zeigen, dass die Drohne auf Commands wartet.

Unterhalb des Start-Buttons befinden sich Informationen zum Verbindungsaufbau mit dem Simulator. Im Feld *IP Address* steht bei aktiver 
Interntverbindung die IP-Addresse des Geräts, auf welchem der Simulator gerade läuft. Wenn keine Internetverbindung besteht kann der Simulator
diese Addresse leider nicht ermitteln. Dann steht in diesem Feld standardmässig die Loopback-Addresse 127.0.0.1.

Im Feld *Command Port* wird die Port-Nummer angezeigt, auf welcher der Simulator seinen DatagramSocket zum empfangen von Commands erstellt hat. Hierhin müssen also von einem Client-Programm die commands geschickt werden.

Das nächste Feld *State Port* gibt den Port an, mit welchem sich die StateConnection des Simulators für das Versenden des Drohnen-Status verbindet. Auf diesem Port sollte man also den Drohnen-Status empfangen.

====== LogBox
Die LogBox an der Unterseite ist ein mächtiges Tool zum Debuggen. Hierhin werden sozusagen alle Aktivitäten des Simulators geloggt. Die verschiedenen Log-Level sind dabei farblich unterschiedlich dargestelt. Das Log-Level lässt sich je nach Bedarf einstellen, und die ListView wird entsprchend gefiltert. Ebenfalls lässt sich mit *Show Timestamp* ein Zeitstempel ein- und ausblenden. Der Button *Autoscroll to Tail* scrollt automatisch immer nach unten zu dem neusten Log-Eintrag.

====== Simulator3DScene
In dem Mittelpunkt des UI steht die Simulator3DScene, auf welcher die ganze 3D-Welt inklusive virtueller Drohne gerendert werden. Hierzu verwendt der Simulator eine JavaFX-SubScene, welche in der umschliessenden BorderPane im Zentrum platziert ist. Neben der 3D-Welt und der Drohne befinden sich zwei Kameras in dem SceneGraph der Subscene: einerseits die vom User kontrollierbare SimulatorCamera sowie die an die Drohne fixierte DroneCamera.

Die DroneView ist die Repräsentation der Drohne im 3D-Raum als 3D-Modell. Ihr Modell wird mittels einem FXML Source File geladen, inklusive animierten Rotoren. Die Position und Rotation der DroneView sind dabei einseitig an die entsprechenden Properties des DroneModels im Backend gebunden. Das heisst wenn sich im DroneModel was ändert, wird dies durch die DroneView in der 3D-Welt abgebildet.

Damit der User das Verhalten der virtuellen Drohne optimal beobachten kann, lässt sich die SimulatorCamera mit der linken Maustaste drehen. Der Pivot-Punkt, um welchen sich die Kamera dreht, transformiet sich dabei gleichmässig mit der Drohne. So fliegt die Drohne nicht plötzlich aus dem Sichtfeld. Ebenfalls lässt sich die Kamera mit der rechten Maustaste oder durch das Drücken des Mausrads nach links und rechts verschieben, um eine andere Perspektive zu erhalten. Die Zoom-Distanz der Kamera lässt sich durch das Scrollen mit dem Mausrad oder dem Touchpad anpassen. Alle diese Manipulationen (Drehen, Verschieben und Zoom) können durch das Halten der Ctrl- bzw. Shift-Taste präzisiert bzw. verstärkt werden.


==== Backend
Die Netzwerkdschnittstelle und die grundlegenden Logiken des Simulators wurden stets unter Berücksichtigung des Verhalten der echten Tello-Drohne implementiert. Ohne Zugang zum Source-Code der Tello-Drohne war dies nicht immer einfach. Als Ausgangslage diente uns die offizielle Tello SDK 2.0 User Guide <<sdk2.0userguide>> sowie eine Tello-Drohne, welche wir als Testobjekt verwenden konnten. Damit liessen sich Stück für Stück die Logiken der Tello-Drohne rekonstruieren und in den Simulator implementieren.

Systembedingt mussten auch einige Spezialfälle berücksichtigt werden. Der Simulator kann zum Beispiel im Gegensatz der echten Drohne kein eigenes Wireless-Netzwerk aufbauen. Aussderem muss der Simulator auch auf dem gleichen Gerät laufen können wie das Client-Programm. Dabei kann es zu Konflikten mit der Port-Belegung kommen. Bei der Tello-Drohne hat man diese Probleme nicht, da die Drohne immer alle Ports für sich selbst zur Verfügung hat.

Um die zentralen Datenflüsse der Tello-Drohne abzubilden, implementiert der TelloSimulator zwei Threads, welche parallel zu dem Hauptprogramm  laufen: die *CommandConnection* und die *StateConnection*. Die *VideoConnection* als letzter Teil dieser Dreifaltigkeit wurde aus Ressourcengründen leider nicht umgesetzt.

===== CommandConnection
Sobald der Benutzer die virtuelle Drohne einschaltet, wird eine neue Instanz der CommandConnection erstellt und der Thread gestartet. Beim Erstellen des Sockets besteht hierbei eine Eigenheit des Simulators. Der Standard-Port der Tello-Drohne wäre 8889, jedoch wird dieser Port in den meisten Fällen schon durch das ebenfalls lokal laufende Client-Programm belegt sein. Deshalb bindet sich der Simulator-DatagramSocket der CommandConnection bewusst zum Port 8879 anstatt 8889. Danach empfängt der Thread laufend UDP-Pakete auf diesem Socket.

Nach einem initalen `command`-Command wird dann wie bei der echten Tello-Drohe der SDK Mode aktiviert. Ab dann ist die Drohne bereit für andere Commands. Gleichzeitig bewirkt dies die Initierung der StateConnection, welche ab dann regelmässig den Drohnen-Status versendet. 

Alle über die CommandConnection empfangenen Nachrichten werden gewrappt als CommandPackage samt Herkunfts-Addresse und Herkunfts-Port an die CommandHandler-Klasse weitergegeben. 


===== StateConnection
Die StateConnection ist ein Stück weniger kompliziert, da sie sich nur mit dem Versenden des Drohnen-Status befassen muss. Nach dem Start durch die CommandConnection schickt die StateConnection asynchron alle 100 ms den Status der Drone im entsprechenden Format an die Addresse, von welcher das erste `command`-Command empfangen wurde. Da auf dem State-Port nichts empfangen werden muss, verwendet der Simulator hier den gleichen Port wie die Tello-Drohne.

===== CommandHandler
Die Aufgabe der CommandHandler-Klasse ist es, mit den verschiedenen Commands umzugehen. Der CommandHandler splittet die über die CommandConnection empfangenen Command-Strings auf und extrahiert die enthaltenen Parameter. Anschliessend wird über ein grosses Switch-Statement jedes Command validiert und zu den entsprechenden Methoden im DroneController weitergeleitet.

===== DroneController
Diese Klasse steuert die virtuelle Drohne und enthält ihre gesamte Logik. Sie aktualisiert und animiert alle Daten, die in dem DroneModel gespeichert sind, dem sie zugeordnet ist. Die Methoden des DroneControllers führen die Befehle aus, wenn sie vom CommandHandler aufgerufen werden. Ebenfalls sendet der Controller asynchrone Antworten über den CommandResponseSender an das Client-Programm, sobald ein bestimmtes Command fertig ausgeführt wurde.

===== DroneModel
Die Model-Klasse, welche das Datenmodell der Tello-Drohne repräsentiert. Die Werte des DroneModel werden nur durch die Logik des DroneControllers verändert und im Frontend durch die an seine Properties gebundene Views dargestellt. Dabei dient das DroneModel als *_single source of truth_* für alle anderen Komponenten, die auf die Parameter der Drohne zugreifen möchten. Dies gewährleistet die Datenintegrität und ermöglicht eine einfachere Skalierbarkeit der Applikation in Zukunft.

=== UDP-Schnittstelle

Wie bei der Tello-Drohne findet auch beim Simulator die gesamte Kommunikation über das UDP-Netzwerkprotokoll statt.
Um den Verbindungsaufbau mit dem Simulator ähnlich wie mit der Tello-Drohne zu gestalten, haben wir die
Schnittstelle so weit wie möglich gleich gestaltet, wie sie von der Tello-Drohne implementiert wird. Als Grundlage
diente uns hierbei der offizielle Tello SDK 2.0 User Guide <<sdk2.0userguide>>. Dazu führten wir eigene Tests mit der
Tello-Drohne durch, welche die teilweise lückenhafte Dokumentation im User Guide ergänzten.

==== Die UDP-Schnittstelle der Tello-Drohne



=== Programmierschnittstelle

In diesem Kapitel wird die Programmierschnittstelle des Simulators beschrieben. Dazu gehören alle Commands, welche vom
Simulator unterstützt werden.

=== Mögliche Weiterentwicklungen

Obwohl der Simulator in seinem jetzigen Zustand die Grundanforderungen abdeckt, gibt es noch diverse Funktionen,
die aus Ressourcengründen im Backlog unseres Projekts geblieben sind.

==== Video-Stream


==== <Weitere Features die wir nicht umsetzen konnten>

== Fazit
== Danksagung
== Referenzen
=== Literaturverzeichnis
[bibliography]
- [[[telloedu,1]]] https://www.ryzerobotics.com/tello-edu +
- [[[sdk2.0userguide,2]]] https://dl-cdn.ryzerobotics.com/downloads/Tello/Tello%20SDK%202.0%20User%20Guide.pdf +

=== Abbildungsverzeichnis
- [[[gui-usability-testing,1]]] *Abbildung 1:* GUI zum Stand des Usability Testings

== Ehrlichkeitserklärung
== Anhang
=== Installationsanleitung Tello Simulator
=== Operator-Programm mit der Simulator-API verbinden
=== Benutzerhandbuch Tello Simulator
